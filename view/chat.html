<!DOCTYPE html>
<html>
<head>
    <title>404 Not Found âŒ</title>
    <style>
        body { background: #181818; margin: 0; padding-bottom: 3rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #form { background: rgba(0, 0, 0, 0.15); padding: 0.25rem; position: fixed; bottom: 0; left: 0; right: 0; display: flex; height: 3rem; box-sizing: border-box; backdrop-filter: blur(10px); }
        #input { border: none; padding: 0 1rem; flex-grow: 1; border-radius: 2rem; margin: 0.25rem; }
        #input:focus { outline: none; }
        #form > button { background: #333; border: none; padding: 0 1rem; margin: 0.25rem; border-radius: 3px; outline: none; color: #fff; }

        /*
        #messages { list-style-type: none; margin: 0; padding: 0; }
        #messages > li { padding: 0.5rem 1rem; }
        #messages > li:nth-child(odd) { background: #efefef; } /* í™€ìˆ˜ ë²ˆì§¸ ìì‹ì¸ ìš”ì†Œë§Œ ì ìš© (ì§ìˆ˜ëŠ” even) 
        */

        #messages {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
    
        #messages li {
            padding: 8px 12px;
            margin-bottom: 10px;
            border-radius: 18px;
            max-width: 60%;
            word-wrap: break-word;
        }

        /* ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ */
        #messages li.my-message {
            background: #1e213f; /* ê²€í‘¸ë¥¸ ë°°ê²½ */
            margin-left: auto; /* ì˜¤ë¥¸ìª½ ì •ë ¬ */
        }

        /* ë‹¤ë¥¸ ì‚¬ëŒì´ ë³´ë‚¸ ë©”ì‹œì§€ */
        #messages li.other-message {
            background: #1F1F1F; /* ê²€ì€ ë°°ê²½ */
            margin-right: auto; /* ì™¼ìª½ ì •ë ¬ */
        }

        /* í­ì£½ ìº”ë²„ìŠ¤ */
        #fireworksCanvas {
            position: fixed; 
            bottom: 0; /*bottom: 0ì„ ì¶”ê°€í•˜ì—¬ í•˜ë‹¨ ê³ ì • ëª…ì‹œ */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <canvas id="fireworksCanvas"></canvas>  

    <ul id="messages"></ul>
    <form id="form" action="">
        <input id="input" autocomplete="off" /><button>Send</button>
    </form>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ì„œë²„ì— ì—°ê²°í•˜ê¸° ì „ì— ì‚¬ìš©ì ì´ë¦„ì„ ë¨¼ì € ì…ë ¥ë°›ìŠµë‹ˆë‹¤.
        let username = prompt('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!', '');
        if(username == null || username == '') { // ì´ë¦„ì´ ë¹ˆì¹¸ì¸ ê²½ìš°
            const randNum = Math.floor(Math.random() * 100) + 1; // 1 ~ 100
            username = 'ìµëª…' + String(randNum).padStart(3, '0');
        }

        let room = prompt('ì…ì¥í•  ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!');
        if(room == null || room == '') {
            room = 'ê¸°ë³¸ë°©'; // ë°© ì´ë¦„ì´ ì—†ìœ¼ë©´ 'ê¸°ë³¸ë°©'ìœ¼ë¡œ ì„¤ì •
        }

        // ì´ë¦„ ì…ë ¥ì´ ì™„ë£Œëœ í›„ Socket.IO ì„œë²„ì— ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤.
        const socket = io();

        // HTML ìš”ì†Œë“¤ì„ JavaScript ë³€ìˆ˜ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const messages = document.getElementById('messages');

        // ì„œë²„ì— ì—°ê²° ì„±ê³µí•˜ë©´ ë‹‰ë„¤ì„ê³¼ ë°© ì´ë¦„ì„ í•¨ê»˜ ë³´ëƒ…ë‹ˆë‹¤.
        socket.on('connect', function() {
            //ìƒˆë¡œìš´ ìœ ì €ê°€ ì™”ë‹¤ê³  serverì—ê²Œ ì•Œë¦¼ -> serverì—ì„œ onìœ¼ë¡œ ìˆ˜ì‹ 
            socket.emit('joinRoom', {
                user: username,
                room: room
            });
        });

        // í¼ ì œì¶œ(ë©”ì‹œì§€ ì „ì†¡ ë²„íŠ¼ í´ë¦­ ë˜ëŠ” ì—”í„° í‚¤) ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•©ë‹ˆë‹¤.
        form.addEventListener('submit', (e) => {
            e.preventDefault(); // í¼ ì œì¶œ ì‹œ ê¸°ë³¸ ë™ì‘(í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨)ì„ ë§‰ìŠµë‹ˆë‹¤.
            if (input.value) { // ì…ë ¥ í•„ë“œì— ë‚´ìš©ì´ ìˆì„ ê²½ìš°
                const encodedMsg = xorBase64Encrypt(input.value); // ë‚œë…í™”
                
                // 'chatMessage'ë¼ëŠ” ì´ë²¤íŠ¸ë¡œ ì…ë ¥ëœ ê°’ì„ ì„œë²„ì— ë³´ëƒ…ë‹ˆë‹¤.
                socket.emit('chatMessage', {
                    user: username, // ë‹‰ë„¤ì„
                    msg: encodedMsg, // ë©”ì‹œì§€
                    room: room // ì±„íŒ…ë°© ì´ë¦„
                });
                input.value = ''; // ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ í›„ ì…ë ¥ í•„ë“œë¥¼ ë¹„ì›ë‹ˆë‹¤.
            }
        });

        // ì„œë²„ë¡œë¶€í„° 'chatMessage' ì´ë²¤íŠ¸ê°€ ë„ì°©í•˜ëŠ” ê²ƒì„ ê°ì§€í•©ë‹ˆë‹¤.
        socket.on('chatMessage', (data) => {
            const item = document.createElement('li'); // ìƒˆë¡œìš´ 'li' ìš”ì†Œë¥¼ ë§Œë“­ë‹ˆë‹¤.
            const decodedMsg = xorBase64Decrypt(data.msg); // ë‚œë…í™” ë³µí˜¸í™”
            item.textContent = `[${data.user}] : ${decodedMsg}`; // 'li' ìš”ì†Œì˜ ë‚´ìš©ì„ ë°›ì€ ë©”ì‹œì§€ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
            item.style.color = data.color;  // í°íŠ¸ ìƒ‰ìƒ ë³€ê²½

            // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ì¸ì§€ í™•ì¸ í›„ í´ë˜ìŠ¤ë¥¼ ì¶”ê°€
            if (data.user === username) {
                item.classList.add('my-message');
            } else {
                item.classList.add('other-message');
            }

            messages.appendChild(item); // ë©”ì‹œì§€ ëª©ë¡ì— 'li' ìš”ì†Œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
            window.scrollTo(0, document.body.scrollHeight); // ìŠ¤í¬ë¡¤ì„ ê°€ì¥ ì•„ë˜ë¡œ ë‚´ë¦½ë‹ˆë‹¤.

            // íŠ¹ì • ë‹¨ì–´ ë‚˜ì˜¤ë©´ í­ì£½ í…ìŠ¤íŠ¸ ì¶”ê°€
            const celebrationKeywords = ['ì¶•í•˜', 'ã…Šã…‹', 'í‡´ê·¼', 'ì—°ì°¨', 'ë°˜ì°¨', 'í‡´ì‚¬'];
            if (celebrationKeywords.some(keyword => decodedMsg.includes(keyword))) {
                const item = document.createElement('li'); 
                item.textContent = "ğŸ‰ğŸ‰ğŸ‰";
                // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ì¸ì§€ í™•ì¸ í›„ í´ë˜ìŠ¤ë¥¼ ì¶”ê°€
                if (data.user === username) {
                    item.classList.add('my-message');
                } else {
                    item.classList.add('other-message');
                }
                messages.appendChild(item); 
                window.scrollTo(0, document.body.scrollHeight);

                setTimeout(() => {
                    launchFireworks();
                }, 500);
            }
        });

        /* ì„œë²„ì—ì„œ userState ì´ë²¤íŠ¸ ë„ì°© ê°ì§€ */
        socket.on('userState', function(data) {
            // íƒ€ì…ì— ë”°ë¼ ì ìš©í•  í´ë˜ìŠ¤ë¥¼ ë‹¤ë¥´ê²Œ ì§€ì •
            
            // ì…ì¥
            if(data.type == 'in') { 
                const item = document.createElement('li'); 
                item.style.color = 'white';  // í…ìŠ¤íŠ¸ ìƒ‰ í•˜ì–‘
                item.textContent = data.message; 
                messages.appendChild(item); // ë©”ì‹œì§€ ëª©ë¡ì— 'li' ìš”ì†Œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
                window.scrollTo(0, document.body.scrollHeight); // ìŠ¤í¬ë¡¤ì„ ê°€ì¥ ì•„ë˜ë¡œ ë‚´ë¦½ë‹ˆë‹¤.
            } 
            
            // í‡´ì¥
            if(data.type == 'out') { 
                const item = document.createElement('li'); 
                item.style.color = 'red';  // í…ìŠ¤íŠ¸ ìƒ‰ ë¹¨ê°•
                item.textContent = data.message; 
                messages.appendChild(item); // ë©”ì‹œì§€ ëª©ë¡ì— 'li' ìš”ì†Œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
                window.scrollTo(0, document.body.scrollHeight); // ìŠ¤í¬ë¡¤ì„ ê°€ì¥ ì•„ë˜ë¡œ ë‚´ë¦½ë‹ˆë‹¤.
            }
        });


        /* ë‚œë…í™”ë¥¼ ìœ„í•œ ì•”í˜¸í™” í•¨ìˆ˜ ì‹œì‘ */
        const xorKey = 'aaa%kiPsVkS@UC!5'

        // XOR + Base64 ì•”í˜¸í™” í•¨ìˆ˜
        function xorBase64Encrypt(text) {
            // 1ë‹¨ê³„: í…ìŠ¤íŠ¸ë¥¼ UTF-8ë¡œ ì¸ì½”ë”©
            const utf8Text = unescape(encodeURIComponent(text));
            
            // 2ë‹¨ê³„: XOR ì•”í˜¸í™”
            let xorResult = '';
            for (let i = 0; i < utf8Text.length; i++) {
                const textChar = utf8Text.charCodeAt(i);
                const keyChar = xorKey.charCodeAt(i % xorKey.length);
                xorResult += String.fromCharCode(textChar ^ keyChar);
            }
            
            // 3ë‹¨ê³„: Base64 ì¸ì½”ë”©
            return btoa(xorResult);
        }

        // XOR + Base64 ë³µí˜¸í™” í•¨ìˆ˜
        function xorBase64Decrypt(encrypted) {
            // 1ë‹¨ê³„: Base64 ë””ì½”ë”©
            const base64Decoded = atob(encrypted);
            
            // 2ë‹¨ê³„: XOR ë³µí˜¸í™”
            let xorResult = '';
            for (let i = 0; i < base64Decoded.length; i++) {
                const encChar = base64Decoded.charCodeAt(i);
                const keyChar = xorKey.charCodeAt(i % xorKey.length);
                xorResult += String.fromCharCode(encChar ^ keyChar);
            }
            
            // 3ë‹¨ê³„: UTF-8 ë””ì½”ë”©
            return decodeURIComponent(escape(xorResult));
        }
        /* ë‚œë…í™”ë¥¼ ìœ„í•œ ì•”í˜¸í™” í•¨ìˆ˜ ë */


        /* í­ì£½ íŒŒí‹°í´ ê´€ë ¨ ì‹œì‘ */
        // ìº”ë²„ìŠ¤ ì„¤ì •
        const canvas = document.getElementById('fireworksCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // íŒŒí‹°í´ í´ë˜ìŠ¤
        class Particle {
            constructor(x, y, vx, vy, color, life) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.color = color;
                this.life = life;
                this.maxLife = life;
                this.gravity = 0.1;
                this.size = Math.random() * 3 + 2;
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += this.gravity;
                this.life--;
                this.vx *= 0.98;
            }
            
            draw() {
                const alpha = this.life / this.maxLife;
                ctx.globalAlpha = alpha;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        // í­ì£½ í´ë˜ìŠ¤
        class Firework {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.particles = [];
                this.colors = [
                    '#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', 
                    '#f0932b', '#eb4d4b', '#6c5ce7', '#a29bfe',
                    '#fd79a8', '#fdcb6e', '#e84393', '#00b894'
                ];
                this.explode();
            }
            
            explode() {
                const particleCount = 50 + Math.random() * 50;
                const color = this.colors[Math.floor(Math.random() * this.colors.length)];
                
                for (let i = 0; i < particleCount; i++) {
                    const angle = (Math.PI * 2 * i) / particleCount;
                    const speed = Math.random() * 5 + 3;
                    const vx = Math.cos(angle) * speed;
                    const vy = Math.sin(angle) * speed;
                    const life = 60 + Math.random() * 40;
                    
                    this.particles.push(new Particle(this.x, this.y, vx, vy, color, life));
                }
            }
            
            update() {
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const particle = this.particles[i];
                    particle.update();
                    
                    if (particle.life <= 0) {
                        this.particles.splice(i, 1);
                    }
                }
            }
            
            draw() {
                this.particles.forEach(particle => particle.draw());
            }
            
            isDead() {
                return this.particles.length === 0;
            }
        }

        // í­ì£½ ê´€ë¦¬
        let fireworks = [];
        let isAnimating = false;

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            for (let i = fireworks.length - 1; i >= 0; i--) {
                const firework = fireworks[i];
                firework.update();
                firework.draw();
                
                if (firework.isDead()) {
                    fireworks.splice(i, 1);
                }
            }
            
            if (fireworks.length > 0) {
                requestAnimationFrame(animate);
            } else {
                isAnimating = false;
            }
        }

        // í­ì£½ ë°œì‚¬ í•¨ìˆ˜
        function launchFireworks() {            
            // ì—¬ëŸ¬ ê°œì˜ í­ì£½ì„ ìˆœì°¨ì ìœ¼ë¡œ ë°œì‚¬
            const fireworkCount = 5 + Math.random() * 5;
            
            for (let i = 0; i < fireworkCount; i++) {
                setTimeout(() => {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * (canvas.height * 0.6) + (canvas.height * 0.1);
                    
                    fireworks.push(new Firework(x, y));
                    
                    if (!isAnimating) {
                        isAnimating = true;
                        animate();
                    }
                }, i * 200);
            }
        }
        /* í­ì£½ íŒŒí‹°í´ ê´€ë ¨ ë */
    </script>
</body>
</html>
